# Chrome 扩展调试指南

## 问题：新建书签刷新后消失

### 快速诊断（2分钟）

#### 步骤 1：打开开发者工具

1. 打开 Chrome 扩展（点击扩展图标或访问扩展页面）
2. **F12** 打开开发者工具
3. 切换到 **Console** 标签页

#### 步骤 2：运行诊断脚本

1. 打开项目根目录的 `debug-storage.js` 文件
2. **全选** 脚本内容（Ctrl+A 或 Cmd+A）
3. **复制** (Ctrl+C 或 Cmd+C)
4. 切换到浏览器的 Console 标签页
5. **粘贴** 脚本（Ctrl+V 或 Cmd+V）
6. **回车** 运行

#### 步骤 3：查看输出

脚本会显示：

```
=== Chrome Storage 诊断开始 ===

✅ Chrome Storage API 可用

📦 Chrome Storage 中的所有 key:
['navigator_bookmarks', 'navigator_categories', ...]

📚 书签数据 (navigator_bookmarks):
  总数: 5
  置顶书签数: 2
  [0] Google - isPinned: true, source: user
  [1] GitHub - isPinned: true, source: user

  📌 置顶书签详情:
    [0] Google
        isPinned: true
        pinnedAt: 2025-01-15T10:30:00.000Z
        source: user
```

### 关键检查点

#### ✅ 正常情况

- `Chrome Storage API 可用`
- `书签数据: 总数 > 0`
- `置顶书签数 > 0`（如果你置顶了书签）
- `写入测试成功`

#### ❌ 异常情况及解决方案

| 现象 | 可能原因 | 解决方法 |
|-----|---------|---------|
| `没有书签数据` | 数据从未写入 | 检查 `chrome-storage.ts` 的 `saveBookmark` 方法 |
| `置顶书签数: 0` | `isPinned` 字段丢失 | 检查序列化逻辑（第 146-153 行） |
| `书签数据格式错误` | 存储了非数组数据 | 清除存储重新测试 |
| `写入测试失败` | Storage API 权限问题 | 检查 `manifest.json` 权限配置 |

### 完整测试流程

#### 测试 1：写入验证

1. **操作前**：运行诊断脚本，记录书签数量
2. **执行操作**：
   - 添加一个新书签（例如 `https://www.test.com`）
   - 点击"置顶"按钮
3. **立即验证**：再次运行诊断脚本
4. **预期结果**：
   - 书签总数 +1
   - 置顶书签数 +1
   - 新书签显示在列表中，`isPinned: true`

#### 测试 2：刷新验证

1. **刷新前**：运行诊断脚本，记录数据
2. **刷新页面**（F5 或 Ctrl+R）
3. **刷新后**：立即运行诊断脚本
4. **对比结果**：
   - 书签总数应该一致
   - 置顶书签数应该一致
   - 置顶书签的 `isPinned` 应该仍为 `true`

#### 测试 3：并发置顶验证

1. 快速连续置顶 3 个书签（间隔 < 1 秒）
2. 运行诊断脚本
3. **预期结果**：3 个书签都显示 `isPinned: true`

## 查看实时日志

### 开发环境日志

如果你运行的是 `npm run dev:ext`，部分日志会显示在 Console 中：

```javascript
[ChromeStorage] 写操作排队中... (队列位置: 2)
[ChromeStorage] 写操作开始执行 (队列位置: 2)
```

### 查看后台日志

Chrome 扩展的 Service Worker 日志：

1. 打开 `chrome://extensions`
2. 找到 Navigator 扩展
3. 点击"Service Worker"旁边的"检查视图"
4. 新窗口会显示后台日志

## 清除数据重新测试

如果怀疑是历史数据问题：

### 方法 1：通过 Console 清除

```javascript
chrome.storage.local.clear(() => {
  console.log('✅ Chrome Storage 已清空');
  location.reload();
});
```

### 方法 2：通过扩展管理页面

1. `chrome://extensions`
2. 找到 Navigator 扩展
3. 点击"清除存储数据"
4. 刷新扩展页面

## 常见问题

### Q: Console 在哪里？

**A**: F12 打开开发者工具后，顶部标签页选择 "Console"

### Q: 看不到任何日志？

**A**:
1. 确认是在扩展页面打开的开发者工具（不是普通网页）
2. 检查 Console 的日志级别过滤器（应该显示所有级别）
3. 尝试清除 Console 历史记录后重新操作

### Q: 脚本运行报错？

**A**:
1. 确认完整复制了脚本（包括最后的 `})();`）
2. 确认在 Chrome 扩展环境下运行（不是普通网页）
3. 检查浏览器版本（需要 Chrome 88+）

### Q: 数据显示正常，但界面上看不到？

**A**:
1. 检查视图模式（是否在"主页"视图）
2. 检查书签的 `source` 字段（应该是 `user`，不是 `chrome`）
3. 检查 Vue DevTools 中的 Store 状态

## 预期诊断结果

### 场景 1：数据正常保存

```
📚 书签数据: 总数: 3
📌 置顶书签详情:
  [0] Google (isPinned: true)
  [1] GitHub (isPinned: true)
```

→ **数据持久化正常**，问题可能在读取或显示逻辑

### 场景 2：数据未保存

```
📚 书签数据: 总数: 0
⚠️  没有书签数据
```

→ **数据写入失败**，需要检查 `chrome-storage.ts` 的写入逻辑

### 场景 3：置顶标记丢失

```
📚 书签数据: 总数: 3
置顶书签数: 0
```

→ **`isPinned` 字段未保存**，需要检查序列化逻辑

## 下一步

根据诊断结果告诉我：

1. Console 输出的完整内容（截图或文字）
2. 测试 1、2、3 的结果
3. 数据是否显示正常

我会根据诊断结果精准定位问题！
